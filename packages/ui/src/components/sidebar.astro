---
import ComponentList from './component-list.astro'
import { getPathWithBase } from '@astrobook/core/client'

interface Props {
  storyId: string | null
}
---

<nav
  id="astrobook-navigation"
  class=":uno: box-border flex max-h-full min-h-full flex-col divide-y divide-solid divide-gray-200 overflow-y-auto px-0 pb-8"
>
  <div class=":uno: inline-flex items-center justify-between px-2 py-4">
    <a
      class=":uno: p-2 font-semibold text-gray-500 no-underline transition hover:text-gray-800"
      href={getPathWithBase('/')}
    >
      Astrobook
    </a>
    {
      Astro.props.storyId ? (
        <a
          href={getPathWithBase(`/stories/${Astro.props.storyId}`)}
          class=":uno: block inline-block p-2 font-semibold text-gray-500 no-underline transition hover:scale-110 hover:text-gray-800"
          title="Go full screen"
        >
          <span class=":uno: sr-only">Go full screen</span>
          <span class=":uno: i-lucide-expand block size-4" />
        </a>
      ) : null
    }
  </div>
  <ComponentList storyId={Astro.props.storyId} />
</nav>

<script is:inline>
  ;(() => {
    const elementId = 'astrobook-navigation'
    const sessionKey = 'astrobook-navigation-scroll-position'

    const save = () => {
      const el = document.getElementById(elementId)
      if (!el) return

      sessionStorage.setItem(sessionKey, String(el.scrollTop))
    }

    const throttle = (func, limit) => {
      let pending

      return () => {
        if (pending) return

        pending = 1
        setTimeout(() => {
          pending = 0
          func()
        }, limit)
      }
    }

    const throttledSave = throttle(save, 100)

    const load = () => {
      const el = document.getElementById(elementId)
      if (!el) return

      const scrollPosition = sessionStorage.getItem(sessionKey) || ''
      if (scrollPosition.match(/^\d+(\.\d*)?$/)) {
        el.scrollTop = parseFloat(scrollPosition)
      }

      el.addEventListener('scroll', throttledSave)
    }

    load()

    document.addEventListener('astro:page-load', () => {
      load()
    })
  })()
</script>
